{%load static%}

<!DOCTYPE html>
<html lang="es">
  <head>    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'crece/css/styles.css' %}">
    <link rel="icon" type="image/png" href="{% static 'crece/img/cristo.png' %}">
    <title>FORO</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

<body class="cuerpo">

  <!--ESTA ES LA CABECERA, LA BARRA DE NAVEGACION-->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <img class="navbar-brand" src="{% static 'crece/img/logo_cristo.png' %}" alt="logo">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-0">
            <li class="nav-item">
                <a class="nav-link" aria-current="page" href="{% url 'index' %}">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'nosotros' %}">Nosotros</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'actividades' %}">Actividades</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'puente' %}">Información</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'lista_peticiones' %}">Peticion</a>
              </li>
        </ul>
        <div id="user-info" class="ms-auto">
          <span id="usuario"></span>
      </div>
      </div>
    </div>
  </nav>
  <section>
    <div class="nav">
        <button class="btn btn-light" id="create-conversation">Crear Conversación</button>
        <button class="btn btn-light" id="edit-message" style="display:none;">Editar Mensaje</button>
    </div>
    <div class="container">
        <div class="sidebar">
            <ul id="conversation-list">
                <!-- Conversations will be added here dynamically -->
            </ul>
        </div>
        <div class="chat">
            <!-- Chat windows will be added here dynamically -->
        </div>
    </div>
    <!-- Modal for creating/editing conversations -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title">Título del Modal</h2>
            <form id="conversation-form">
                <div class="form-group">
                    <input type="text" id="title" placeholder="Título (Máximo 50 caracteres)" maxlength="50" required>
                </div>
                <div class="form-group">
                    <textarea id="message" placeholder="Mensaje (Máximo 650 caracteres)" maxlength="650" required></textarea>
                    <span id="char-count-modal">0 / 650 caracteres</span>
                </div>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>
  </section>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    var currentUser = "{{ user.username }}";
    console.log("Usuario logueado:", currentUser);
    $(document).ready(function() {
        $('#usuario').text(currentUser);
        let conversations = [];
        let editingConversationId = null;

        function renderConversations() {
        $('#conversation-list').empty();
        $('.chat').empty();
        conversations.forEach(convo => {
            let modifiedInfo = convo.modified ? `<br>Modificado el: ${convo.modified}` : '';
            $('#conversation-list').append(`<li data-chat="${convo.id}">${convo.title}</li>`);
            $('.chat').append(`
                <div id="chat-${convo.id}" class="chat-window">
                    <div class="chat-header">
                        <p>
                            Usuario: @${currentUser}<br>
                            Creado el: ${convo.created}${modifiedInfo}<br>
                            Título: ${convo.title}
                        </p>
                    </div>
                    <div class="messages">
                        <div class="message">
                            <p>${convo.message}</p>
                        </div>
                    </div>
                    <div class="input-area">
                        <div id="texto-respuesta">
                            <input type="text" id="input-${convo.id}" placeholder="Escribe un mensaje..." maxlength="650">
                            <span class="char-count-input">0 / 650 caracteres</span>
                        </div>
                        <button data-chat="${convo.id}">Enviar</button>
                    </div>
                </div>
            `);

            // Render existing responses
            convo.responses.forEach(response => {
                let responseElement = $(`
                    <div class="message">
                        <p>
                            Usuario: @${response.user}${response.isAuthor ? " (autor)" : ""}<br>
                            Enviado el: ${response.dateTime}
                        </p>
                        <div class="divider"></div>
                        <p>${response.message}</p>
                    </div>
                `);
                $('#chat-' + convo.id + ' .messages').append(responseElement);
            });

            // Add event listener for character count
            $('#input-' + convo.id).on('input', function() {
                var maxLength = $(this).attr('maxlength');
                var currentLength = $(this).val().length;
                $(this).next('.char-count-input').text(currentLength + ' / ' + maxLength + ' caracteres');
            });
        });
    }

    function openModal(title) {
        $('#modal-title').text(title);
        $('#modal').show();
    }

    function closeModal() {
        $('#modal').hide();
        $('#title').val('');
        $('#message').val('');
        $('#char-count-modal').text('0 / 650 caracteres');
        editingConversationId = null;
    }

    $('.sidebar').on('click', 'li', function() {
        var chatId = $(this).data('chat');
        $('.chat-window').hide();
        $('#chat-' + chatId).show();
        $('#edit-message').show();
    });

    $('.chat').on('click', '.input-area button', function() {
        var chatId = $(this).data('chat');
        var input = $('#input-' + chatId);
        var message = input.val().trim();
        var dateTime = new Date();
        var formattedDate = dateTime.toLocaleDateString();
        var formattedTime = dateTime.toLocaleTimeString();

        if (message) {
            var convo = conversations.find(c => c.id == chatId);
            var isAuthor = currentUser === convo.user ? " (autor)" : "";
            convo.responses.push({
                user: currentUser,
                message: message,
                dateTime: formattedDate + ' ' + formattedTime,
                isAuthor: currentUser === convo.user
            });

            var messageElement = $(`
                <div class="message">
                    <p>
                        Usuario: @${currentUser}${isAuthor}<br>
                        Enviado el: ${formattedDate} ${formattedTime}
                    </p>
                    <div class="divider"></div>
                    <p>${message}</p>
                </div>
            `);
            $('#chat-' + chatId + ' .messages').append(messageElement);
            input.val('');
            $('#chat-' + chatId + ' .messages').scrollTop($('#chat-' + chatId + ' .messages')[0].scrollHeight);
            input.next('.char-count-input').text('0 / 650 caracteres'); // Reset character count
        }
    });

    $('#create-conversation').click(function() {
        openModal('Crear Conversación');
    });

    $('#edit-message').click(function() {
        var activeChat = $('.chat-window:visible');
        var chatId = activeChat.attr('id').split('-')[1];
        var convo = conversations.find(c => c.id == chatId);
        editingConversationId = chatId;
        $('#title').val(convo.title);
        $('#message').val(convo.message);
        $('#char-count-modal').text(convo.message.length + ' / 650 caracteres'); // Update character count
        openModal('Editar Mensaje');
    });

    $('#modal .close').click(function() {
        closeModal();
    });

    $('#conversation-form').submit(function(e) {
        e.preventDefault();
        var title = $('#title').val().trim();
        var message = $('#message').val().trim();
        var dateTime = new Date();
        var formattedDate = dateTime.toLocaleDateString();
        var formattedTime = dateTime.toLocaleTimeString();

        if (editingConversationId) {
            var convo = conversations.find(c => c.id == editingConversationId);
            convo.title = title;
            convo.message = message;
            convo.modified = formattedDate + ' ' + formattedTime;
        } else {
            var newConvo = {
                id: conversations.length + 1,
                user: currentUser,
                title: title,
                message: message,
                created: formattedDate,
                responses: []
            };
            conversations.push(newConvo);
        }

        renderConversations();
        closeModal();
    });

    // Initial render
    renderConversations();

    // Character count for modal message
    $('#message').on('input', function() {
        var maxLength = $(this).attr('maxlength');
        var currentLength = $(this).val().length;
        $('#char-count-modal').text(currentLength + ' / ' + maxLength + ' caracteres');
    });
});
  </script>
  

  <!-- estos son los dos scrips que utiliza bootstrap para funcionar, AVERIGUAR-->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
  integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>